{% extends 'base.html' %}
{% block title %}
{{response.Process_Type}}
{% endblock %}
{% block head %}
<script src="../../static/plugins/assets/modules/moment.min.js"></script>
<style>
    .accordion-header[aria-expanded="true"] .accordion-icon i:before {
        content: "\f068";
    }

    .left-align {
        text-align: left;
    }

    .right-align {
        text-align: right;
    }

    .p-4 {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>
{% endblock %}
{% block user %}
{% if authenticated == True %}
{% include 'topbar.html' %}
{% endif %}
{% endblock %}

{% block navigation %}
<li class="nav-item active">
    <a href="#" type="button" class="nav-link" disabled>
        <i class="fas fa-fire text-danger"></i>
        {{response.TenderType}}
    </a>
</li>

{% if authenticated == True %}
<li class="nav-item">
    <a href="/dashboard/" class="nav-link"><i class="fas fa-home"></i><span>Dashboard</span></a>
</li>
{% if state == 'Vendor' %}
<li class="nav-item dropdown">
    <a href="#" data-toggle="dropdown" class="nav-link has-dropdown"><i class="far fa-clone"></i><span>More</span></a>
    <ul class="dropdown-menu">
        <li class="nav-item"><a href="/procurement/Open Tender" class="nav-link">Open Tenders</a></li>
        <li class="nav-item"><a href="/procurement/Restricted Tender" class="nav-link">Restricted Tenders</a></li>
        <li class="nav-item"><a href="/procurement/RFQ" class="nav-link">Request For Quotation</a></li>
        <li class="nav-item"><a href="/procurement/EOI" class="nav-link">Expression Of Interest</a></li>
        <li class="nav-item"><a href="/procurement/RFP" class="nav-link">Request For Proposal</a></li>
    </ul>
</li>
{% endif %}
<li class="nav-item">
    <a href="/logout/" class="nav-link" data-toggle="tooltip" title="Sign Out"><i
            class="fas fa-sign-out-alt"></i><span>Sign
            Out</span></a>
</li>
{% else %}
<li class="nav-item">
    <a href="/" class="nav-link"><i class="fas fa-home"></i><span>Home</span></a>
</li>
<li class="nav-item">
    <a href="#" class="nav-link" data-toggle="modal" data-target="#signIn"><i class="fas fa-user"></i><span>Sign
            In</span></a>
</li>
{% endif %}
{% endblock %}
{% block main %}
<section>
    <div class="section-body">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-3">
                    <div class="p-4 text-white text-lg bg-dark rounded-top">
                        <h2 class="left-align">{{response.TenderType}}</h2>
                        <p class="right-align text-uppercase">{{response.Process_Type}} Reference No - <span
                                class="text-medium">{{response.RefNo}}</span></p>
                    </div>
                    <div class="d-flex flex-wrap flex-sm-nowrap justify-content-between py-3 px-2 bg-secondary">
                        <div class="w-100 text-center py-1 px-2"><span class="text-medium">{{response.Process_Type}}
                                Status:</span> {{response.Status}}
                        </div>
                        <div class="w-100 text-center py-1 px-2"><span class="text-medium">{{response.Process_Type}}
                                Opening Date:</span> <span id="TenderOpeningDate">{{response.TenderOpeningDate}}</span>
                        </div>
                        <div class="w-100 text-center py-1 px-2"><span class="text-medium">{{response.Process_Type}}
                                Closing Date:</span> <span id="TenderClosingDate">{{response.TenderClosingDate}}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div id="accordion">
                                    <div class="accordion">
                                        <div class="accordion">
                                            <div class="accordion-header" role="button" data-toggle="collapse"
                                                data-target="#panel-body-2">
                                                <h4>
                                                    <span class="accordion-icon"><i class="fas fa-plus"></i></span>
                                                    {{response.Title}}
                                                </h4>
                                            </div>
                                            <div class="accordion-body collapse" id="panel-body-2"
                                                data-parent="#accordion">
                                                <p class="mb-0">
                                                    {% if response.Instructions %}
                                                    <h5 class="text-bold my-3">{{response.Process_Type}} Description
                                                    </h5>
                                                    <p>
                                                        {{response.Instructions}}.
                                                    </p>
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <h6>Procurement Items</h6>
                            <table class="table table-striped" id="table-1">
                                <thead>state
                                    <tr>
                                        <th>Description</th>
                                        <th>Unit of Measure</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Amount</th>
                                        {% if authenticated == True and response.Status == 'New' %}
                                        <th>Action</th>
                                        {% endif%}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for line in lines %}
                                    <tr>
                                        <td>{{line.Description}}</td>
                                        <td>{{line.UnitofMeasure}}</td>
                                        <td>{{line.Quantity}} </td>
                                        <td id="UnitPrice{{line.LineNo}}">{{line.UnitPrice}} </td>
                                        <td>{{line.Amount}}</td>
                                        {% if authenticated == True and response.Status == 'New' %}
                                        <td>
                                            <button type="button" class="btn btn-primary" data-toggle="modal"
                                                data-target="#financialBid{{line.LineNo}}"
                                                id="SubmitBtnBG{{line.LineNo}}"><span
                                                    id="lineSubmitBtn{{line.LineNo}}"></span> <i
                                                    class="fas fa-coins"></i></button>
                                        </td>
                                        {% endif%}
                                        <div class="modal fade" tabindex="-1" role="dialog"
                                            id="financialBid{{line.LineNo}}">
                                            <div class="modal-dialog modal-lg" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Financial Bid - {{line.Description}}
                                                        </h5>
                                                        <button type="button" class="close" data-dismiss="modal"
                                                            aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form method="POST" action="/login/" novalidate>
                                                            {% csrf_token %}
                                                            <input type="hidden" name="Process_Type"
                                                                value="{{response.Process_Type}}">
                                                            <input type="hidden" name="TenderType"
                                                                value="{{response.TenderType}}">
                                                            <input type="hidden" name="docNo"
                                                                value="{{line.RequisitionNo}}">
                                                            <div class="form-group">
                                                                <label>Unit Price</label>
                                                                <div class="input-group">
                                                                    <div class="input-group-prepend">
                                                                        <div class="input-group-text">
                                                                            <i class="fas fa-coins"></i>
                                                                        </div>
                                                                    </div>
                                                                    <input type="text" class="form-control"
                                                                        placeholder="00.00" value="{{line.UnitPrice}}"
                                                                        name="unitPrice">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label>Security Institution</label>
                                                                <div class="input-group">
                                                                    <div class="input-group-prepend">
                                                                        <div class="input-group-text">
                                                                            <i class="fas fa-university"></i>
                                                                        </div>
                                                                    </div>
                                                                    <input type="text" class="form-control"
                                                                        name="securityInstitution">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label>Security Amount</label>
                                                                <div class="input-group">
                                                                    <div class="input-group-prepend">
                                                                        <div class="input-group-text">
                                                                            <i class="fas fa-lock"></i>
                                                                        </div>
                                                                    </div>
                                                                    <input type="text" class="form-control"
                                                                        placeholder="00.00" name="securityAmount">
                                                                </div>
                                                            </div>
                                                            <div class="form-group my-2">
                                                                <button type="submit"
                                                                    class="btn btn-primary btn-lg btn-block">
                                                                    Submit <i class="fas fa-paper-plane"></i>
                                                                </button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <script>
                                            $(document).ready(function () {
                                                var unitPrice = $("#UnitPrice{{line.LineNo}}").text();
                                                if (unitPrice == 0) {
                                                    $("#lineSubmitBtn{{line.LineNo}}").text("Bid");
                                                } else {
                                                    $("#lineSubmitBtn{{line.LineNo}}").text("Update Bid");
                                                    $("#SubmitBtnBG{{line.LineNo}}").removeClass(
                                                        'btn-primary');
                                                    $("#SubmitBtnBG{{line.LineNo}}").addClass('btn-warning');
                                                }
                                                $("#TenderOpeningDate{{tender.No}}")
                                                    .empty().append(moment(
                                                            '{{tender.TenderOpeningDate}}', "YYYY-MM-DD")
                                                        .format(
                                                            'Do MMM YYYY'));
                                                $("#TenderClosingDate{{tender.No}}")
                                                    .empty().append(moment(
                                                            '{{tender.TenderClosingDate}}',
                                                            "YYYY-MM-DD, h:mm:ss a")
                                                        .format(
                                                            'Do MMM YYYY, h:mm a'));
                                                $('#UnitPrice{{line.LineNo}}')
                                            })
                                        </script>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if financialBid == True %}
                        <div class="row my-5">
                            <div class="col-md-12 p-2" style="border: 2px dotted black;">
                                <h4 class="">Technical Requirements</h4>
                                <div class="money-spinner mx-auto text-center" id="attachment_spinner"
                                    style="display: none;">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                        alt="Loading Gif" style="height: 100px; width: 100px;" class="img-fluid">
                                </div>
                                <form method="post" id="attachmentsForm" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="form-group">
                                        <label>Select Document to Upload <span class="text-danger">*</span></label>
                                        <select class="custom-select" name="attachmentCode" id="attachmentCode">
                                            <option class="after" value="" disabled>--Select--</option>
                                        </select>
                                    </div>
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" name="attachments"
                                            id="attachments">
                                        <label class="custom-file-label" for="customFile">Choose file</label>
                                    </div>
                                    <div style="display:flex; justify-content:space-between;" class="my-3">
                                        <button type="submit" class="btn btn-primary btn-lg mr-1" style="flex:1;">
                                            Submit <i class="fas fa-paper-plane"></i>
                                        </button>
                                        <button class="btn btn-dark mr-1" type="button" id="attachmentBtn"
                                            style="flex:1;display:none">
                                            View <span id="attachementCount"></span> Attachments <i
                                                class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </form>
                                <div class="row" id="leave_attachments_row" style="display:none">
                                    <div class="col-md-12">
                                        <h5 class="">
                                            Attached Files <i class="las la-folder-open text-success"></i>
                                        </h5>
                                        <div class="row" id="attachments-container">

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="row my-4">
                            <div class="col-md-12">
                                <div
                                    class="steps d-flex flex-wrap flex-sm-nowrap justify-content-between padding-top-2x padding-bottom-1x">
                                    <div class="step stepOne">
                                        <div class="step-icon-wrap">
                                            <div class="step-icon">
                                                <i class="fas fa-bullhorn"></i>
                                            </div>
                                        </div>
                                        <h4 class="step-title">New {{response.Process_Type}}</h4>
                                    </div>
                                    {% if financialBid == True %}
                                    <div class="step completed">
                                        <div class="step-icon-wrap">
                                            <div class="step-icon">
                                                <i class="fa fa-coins"></i>
                                            </div>
                                        </div>
                                        <h4 class="step-title">{{response.Process_Type}} Financial Bid</h4>
                                    </div>
                                    {% else %}
                                    <div class="step">
                                        <div class="step-icon-wrap">
                                            <div class="step-icon">
                                                <i class="fa fa-coins"></i>
                                            </div>
                                        </div>
                                        <h4 class="step-title">{{response.Process_Type}} Financial Bid</h4>
                                    </div>
                                    {% endif %}
                                    <div class="step technicalStep">
                                        <div class="step-icon-wrap">
                                            <div class="step-icon">
                                                <i class="fas fa-upload"></i>
                                            </div>
                                        </div>
                                        <h4 class="step-title">Technical Requirements</h4>
                                    </div>
                                    <div class="step">
                                        <div class="step-icon-wrap">
                                            <div class="step-icon">
                                                <i class="fas fa-check"></i>
                                            </div>
                                        </div>
                                        <h4 class="step-title">Submitted</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    $(document).ready(function () {
        var documentID = '{{response.No}}';
        var Process_Type = '{{response.Process_Type}}';
        const $respondModalBtn = $('#respondModalBtn');
        const $attachmentForm = $('#attachmentsForm');
        const $attachment_spinner = $('#attachment_spinner');
        const $attachmentBtn = $('#attachmentBtn');

        $attachmentForm.on("submit", (e) => {
            e.preventDefault();
            if ($('#attachmentCode').val() === '') {
                alert('Please fill in all required fields.');
                return false;
            }
            $attachment_spinner.show();
            $attachmentForm.hide();
            var formData = new FormData($attachmentForm[0]);
            let attachments = $('#attachments')[0];
            var attachmentCode = $('#attachmentCode').val();

            for (let i = 0; i < attachments.files.length; i++) {
                formData.append('attachment', attachments.files[i]);
            }

            formData.append('attachmentCode', attachmentCode);

            $.ajax({
                url: "/Attachments/" + documentID + "/",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function (data) {
                    $('#attachments').val('');
                    $attachment_spinner.hide();
                    $attachmentForm.show();

                    if (data['success'] == true) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#239B56',
                            icon: 'las la-check-circle',
                            title: 'Yeah',
                            message: "Uploaded successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                        Load_Attachments(documentID);
                        TechnicalRequirementsData(documentID);
                    } else {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: "Upload failed: " + data,
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log(xhr.responseText);
                    $attachment_spinner.hide();
                    $attachmentForm.show();

                }
            });
        });
        TechnicalRequirementsData(documentID);
        Load_Attachments(documentID);

        function TechnicalRequirementsData(pk) {
            $("#attachmentsForm select[name='attachmentCode']").find('.after').nextAll().remove();
            $.ajax({
                url: "/TechnicalRequirements/" + pk + "/",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    console.log(data.length)
                    if (data.length > 0) {
                        let options = '';
                        for (var i = 0; i < data.length; i++) {
                            options += '<option value=' + data[i].DocumentCode + '>' + data[i]
                                .DocumentName +
                                '</option>';
                        }
                        $("#attachmentsForm select[name='attachmentCode']").find('.after').after(
                            options);
                    } else {
                        $('#technicalStep').addClass('completed');
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }

        function Load_Attachments(pk) {
            $.ajax({
                url: "/Attachments/" + pk + "/",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var containerDiv = $("#attachments-container");
                    containerDiv.empty(); // clear the container div
                    let fileCount = data.length
                    if (fileCount > 0) {
                        $('#attachementCount').empty().append(fileCount);
                        $attachmentBtn.show();
                        for (var i = 0; i < data.length; i++) {
                            var docID = data[i].AuxiliaryIndex2;
                            var tableID = data[i].Table_ID;
                            var attachmentID = data[i].AuxiliaryIndex2;
                            var File_Name = data[i].File_Name;
                            var File_Extension = data[i].File_Extension;
                            // create a new div for this attachment
                            var attachmentDiv = $("<div>", {
                                class: "col-lg-4 col-xl-3"
                            });
                            var fileManBoxDiv = $("<div>", {
                                class: "file-man-box"
                            });
                            // create the form for deleting the attachment
                            var deleteForm = $("<form>", {
                                method: "POST"
                            });
                            deleteForm.append($("<input>", {
                                type: "hidden",
                                name: "docID",
                                value: docID
                            }));
                            deleteForm.append($("<input>", {
                                type: "hidden",
                                name: "tableID",
                                value: tableID
                            }));
                            var deleteButton = $("<button>", {
                                class: "file-close",
                                id: "file-close"
                            }).append($("<i>", {
                                class: "fa fa-times-circle"
                            }));
                            deleteButton.on("click", function (event) {
                                event.preventDefault();
                                $attachment_spinner.show();
                                $.ajax({
                                    url: '{% url "DeleteAttachment" %}',
                                    type: 'POST',
                                    data: {
                                        docID: docID,
                                        tableID: tableID,
                                        leaveCode: pk,
                                        csrfmiddlewaretoken: $(
                                                'input[name=csrfmiddlewaretoken]')
                                            .val()
                                    },
                                    success: function (data) {
                                        $attachment_spinner.hide();
                                        if (data['success'] == true) {
                                            iziToast.show({
                                                theme: 'dark',
                                                backgroundColor: '#239B56',
                                                icon: 'las la-check-circle',
                                                title: 'Yeah',
                                                message: data[
                                                    'message'],
                                                position: 'topRight',
                                                progressBarColor: '#F4F6F7',
                                            });
                                            Load_Attachments(pk);
                                            TechnicalRequirementsData(pk);
                                        } else {
                                            iziToast.show({
                                                theme: 'dark',
                                                icon: 'las la-exclamation',
                                                title: 'Error',
                                                message: data['error'],
                                                position: 'topRight',
                                                progressBarColor: '#ff0800',
                                            });
                                        }
                                    },
                                    error: function (error) {
                                        $attachment_spinner.hide();
                                        console.log(error)
                                    }
                                });
                            });
                            fileManBoxDiv.append(deleteButton);
                            // create the div for the file icon
                            var fileImgBoxDiv = $("<div>", {
                                class: "file-img-box"
                            }).append($("<img>", {
                                src: "../../static/img/logo/f1.png",
                                alt: "icon"
                            }));
                            fileManBoxDiv.append(fileImgBoxDiv);
                            // create the div for the file name
                            var fileManTitleDiv = $("<div>", {
                                class: "file-man-title"
                            }).append($("<h5>", {
                                class: "mb-0 text-overflow"
                            }).text(File_Name + "." + File_Extension));
                            fileManBoxDiv.append(fileManTitleDiv);
                            attachmentDiv.append(fileManBoxDiv);
                            containerDiv.append(attachmentDiv);
                        }
                    } else {
                        $attachmentBtn.hide();
                    }

                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }
        $attachmentBtn.click(function () {
            $('#leave_attachments_row').toggle(1000);
        })
        $("#TenderOpeningDate")
            .empty().append(moment(
                    '{{response.TenderOpeningDate}}', "YYYY-MM-DD")
                .format(
                    'Do MMM YYYY'));
        $("#TenderClosingDate")
            .empty().append(moment(
                    '{{response.TenderClosingDate}}',
                    "YYYY-MM-DD, h:mm:ss a")
                .format(
                    'Do MMM YYYY, h:mm a'));
        var procurementStatus = '{{response.Status}}'
        if (procurementStatus == 'New') {
            $('.stepOne').addClass('completed')
        }
    })
</script>
{% endblock %}